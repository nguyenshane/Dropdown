<!DOCTYPE html>
<head>
  <title>Drop Down Index</title>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <link rel="stylesheet" href="/components/supersonic/css/supersonic.css">
  <link rel="stylesheet" href="/stylesheets/application.css">
  <link rel="import" href="/components/supersonic/components/import.html">

  <script src="http://localhost/cordova.js"></script>
  <script src="/components/steroids-js/steroids.js"></script>
  <script src="/components/angular/angular.js"></script>
  <script src="/components/supersonic/supersonic.js"></script>

  <!-- Import Polymer -->
  <script src="/components/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="/components/core-elements/core-elements.html">
  <link rel="import" href="/components/core-scroll-threshold/core-scroll-threshold.html">
  <link rel="import" href="/components/core-icons/core-icons.html">
  <link rel="import" href="/components/core-icons/image-icons.html">
  <link rel="import" href="/components/core-icons/av-icons.html">
  <link rel="import" href="/components/core-icons/social-icons.html">
  <link rel="import" href="/components/core-icon-button/core-icon-button.html">
  <link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="/components/paper-button/paper-button.html">
  <link rel="import" href="/components/paper-fab/paper-fab.html">
  <link rel="import" href="/components/paper-tabs/paper-tabs.html">
  <link rel="import" href="/components/paper-spinner/paper-spinner.html">
  <link rel="import" href="/components/paper-dialog/paper-action-dialog.html">
  <link rel="import" href="/components/paper-item/paper-item.html">
  <link rel="import" href="/components/core-animated-pages/core-animated-pages.html">
  <link rel="import" href="/components/core-animated-pages/transitions/slide-up.html">
  <link rel="import" href="/components/core-animated-pages/transitions/slide-down.html">
  <link rel="import" href="/components/core-animated-pages/transitions/slide-from-right.html">
  <link rel="import" href="/components/core-animated-pages/transitions/cross-fade.html">
  <link rel="import" href="/components/core-animated-pages/transitions/list-cascade.html">
  <link rel="import" href="/components/core-animated-pages/transitions/scale-up.html">

  <link rel="import" href="my-core-drag-drop.html">

  <!-- Import Jquery -->
  <script src="/components/localforage/dist/localforage.min.js"></script>
  <script src="/components/jquery/dist/jquery.min.js"></script>
  <script src="/scripts/jquery.db.0.1.3.min.js"></script>
  <script src="/scripts/application.js"></script>

</head>

<body fullbleed layout vertical>
<script>
    supersonic.ui.navigationBar.hide(); 
</script>
<polymer-element name="drop-down">
<template>
<style>
core-animated-pages {
  height: 100%;
  width: 100%;
  position: initial;
}

.greeting {
  text-align: center;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.95);
  margin: 10px 0;
}

core-header-panel {
  background: rgba(255, 255, 255, 0.95);
}

core-toolbar#mainheader {
  background-color: rgba(64, 78, 88, 1);
  color: #fff3ef;
}

paper-tabs {
  background: rgba(86, 105, 118, 1);
  color: rgba(255, 255, 255, 0.18);
}

paper-tab.core-selected {
  color: rgba(255, 255, 255, 0.95);
}

paper-tab::shadow #ink {
  color: rgba(255, 255, 255, 0.95);
}

paper-tabs::shadow #selectionBar {
  background-color: rgba(129, 24, 12, 0.79);
}

core-animated-pages {
  display: initial; /*uncomment this for ios*/
}
.maincircuit {
  background-color: rgba(86, 105, 118, 1);
  padding: 10px;
}

#navheader {
  background-color: rgba(64, 78, 88, 1);
  color:white;
}

.navitem {
  margin: 0;
  padding: 10px;
}

#title {
  text-align: center;
}

.content {
  
}

.tall {

}

.middle {

}

#start-btn {
  background: #f56b4e;
  color: white;
  margin: 0 auto;
  border-radius: 30px;
  width: 230px;
  text-transform: none;
  margin: 10px auto;
}

#section {
  height: 5000px;
  background: #313d46;
}

core-drawer-panel:not([narrow]) #navicon {
  display: none;
}


.chip-container-main {
  text-align: center;
  position: relative;
  
}

.chip-container-top {
  text-align: center;
  position: relative;
  
}

.chip-container-bottom {
  text-align: center;
  position: relative;
  
}

.completed {
  position: absolute;
  background: rgba(71, 71, 71, 0.8);
  width: 100%;
  height: 100%;
  border-radius: 3px;  
  text-align: center;
  vertical-align: middle;
}

.completed-icon {
  color: rgba(255, 255, 255, 0.95);
  margin: auto;
  width: 50px;
  height: 50px;
  display: block;
  pointer-events: none;
}

.chip {
  display: inline-block;
  position: relative;
  border-radius: 3px;
  margin: 4px;
  overflow: hidden;
  text-align: start;
  background-color: rgba(74, 90, 102, 1);
  box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.16);
  height: 100%;
  color: rgba(255, 255, 255, 0.79);
}

.chip-top {

}

.point {
  background: rgba(129, 24, 12, 0.79);
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 0.7em;
  text-transform: lowercase;
  float: right;
  margin: 10px 10px 0;
  /*box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);*/
  color: rgba(237, 237, 237, 0.79);
  opacity: 50%;
}

.chip-middle {
  padding: 4px;
  pointer-events: none;
}

.number {
  font-size: 3em;
  color: rgba(255, 255, 255, 0.79);
}

.chip-bottom {
  padding: 8px;
  font-size: 1em;
  pointer-events: none;
}

.chip-title {
  font-weight: bold;
  pointer-events: none;
}

#details {
  padding: 0px;
  /*background: #15b8a3;*/
}

.scroller {
  height: 250px;
  padding: 10px;
  overflow: auto;
}

.user {
  padding: 2px;
  border-bottom: rgb(242, 242, 242) solid 1px;
}

.user_photo_container {
  border-radius: 50%;
  width: 50px;
  height: 50px;
  padding: 0;
  margin-top: 2px;
  position: relative;
  margin-right: -10px !important;
}

.user_photo {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  position: relative;
}

.user_photo_ripple {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  overflow: hidden;
}

.user_name {
  font-size: 1.2em;
  bottom: 20px;
  margin-left:8px;
  position: relative;
}

.fl_point {
  background: rgba(129, 24, 12, 0.79);
  padding: 4px;
  border-radius: 3px;
  font-size: 0.7em;
  text-transform: lowercase;
  margin: 0px 5px;
  bottom: 22px;
  color: rgba(237, 237, 237, 0.79);
  opacity: 50%;
  position: relative;
}

.fl_icon_container {
  float: right;
  width: 100%;
  text-align: right;
  bottom: 12px;
  margin-top: -10px;
  position: relative;
}

.fl_icon {
  height: 15px;
  width: 15px;
}

.fl_throwdown {
  background: rgba(236, 97, 12, 0.94);
  padding: 8px;
  border-radius: 3px;
  margin: 0px 5px;
  text-transform: lowercase;
  bottom: 20px;
  color: rgba(237, 237, 237, 0.79);
  position: relative;
}

.fl_throwdown_off {
  background: rgba(174, 164, 158, 0.94);
  padding: 8px;
  border-radius: 3px;
  margin: 0px 5px;
  text-transform: lowercase;
  bottom: 20px;
  color: rgba(237, 237, 237, 0.79);
  position: relative;
}

.fl_dropdown {
  background: rgba(213, 11, 72, 0.94);
  padding: 8px;
  border-radius: 3px;
  margin: 0px 5px;
  text-transform: lowercase;
  bottom: 20px;
  color: rgba(237, 237, 237, 0.79);
  position: relative;
}

.fl_dropdown_off {
  background: rgba(174, 164, 158, 0.94);
  padding: 8px;
  border-radius: 3px;
  margin: 0px 5px;
  text-transform: lowercase;
  bottom: 20px;
  color: rgba(237, 237, 237, 0.79);
  position: relative;
}

.add_friend {
  border-radius: 30%;
  float: right;
  background: rgba(74, 90, 102, 0.85);
  position: relative;
  top: 8px;
  color: white;
}

.card {
  height: 100%;
  margin: 0;
  border-radius: 0px;
  text-align: start;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  text-align: center;
}

.card-top {
  padding: 20px;
  color: white;
  font-size: 2em;
  text-align: center;
  background: rgba(64, 78, 88, 0.9);
}

.card-top-sub {
  padding: 20px;
  color: white;
  font-size: 2em;
  text-align: center;
  background: rgba(74, 90, 102, 0.8);
}

.card-bottom {
  height: 100%;
}

.play-icon {
  border-radius: 60%;
  width: 60px;
  height: 60px;
  margin-right: 16px;
  color: #fff;
  background: rgba(74, 90, 102, 0.8);
  padding: 10px 12px 14px 10px;
}

.play-icon /deep/ core-icon[role=img] {
    height: 100%;
    width: 100%;
    padding: 1px;
    margin: 1px;
  }

.card-album-title {
  font-size: 2em;
}


</style>

<core-overlay backdrop autoCloseDisabled layered opened="{{set_busy_spinner}}" transition="core-transition-center" id="busy_spinner" class="busy_spinner" style="text-align:center;">
  <!-- place all overlay styles inside the overlay target -->
  <style no-shim>
    .busy_spinner {
      width:110px;
      height:110px;
      overflow:hidden;
    }

    .busy_spinner_icon {
      width: 100px;
      height: 100px;
    }
  </style>
  <paper-spinner active class="busy_spinner_icon"></paper-spinner>
</core-overlay>
<core-animated-pages selected="{{page}}" transitions="hero-transition slide-up slide-down cross-fade list-cascade scale-up" on-core-animated-pages-transition-end="{{complete}}">
<section>
  <core-drawer-panel id="drawerPanel" rightDrawer forceNarrow drawerWidth="190px">
    
    <core-header-panel drawer>
      <!--<core-toolbar id="navheader" cross-fade>
        <span>Menu</span>
      </core-toolbar>-->
        <paper-item class="navitem" on-click="{{refresh}}">
          <core-icon icon="refresh"></core-icon>&nbsp;&nbsp;&nbsp;&nbsp;Refresh
          </paper-item>
        <paper-item class="navitem" on-click="{{settings}}">
          <core-icon icon="settings"></core-icon>&nbsp;&nbsp;&nbsp;&nbsp;Settings
        </paper-item>
        <paper-item class="navitem" on-click="{{logout}}">
          <core-icon icon="exit-to-app"></core-icon>&nbsp;&nbsp;&nbsp;&nbsp;Logout
        </paper-item>
     </core-header-panel>

    <core-header-panel main>
      <my-core-drag-drop></my-core-drag-drop>
      <core-toolbar id="mainheader">
        <div class="user_photo_container">
          <img class="user_photo" style="border: rgba(255, 255, 255, 0.52) 2px solid;" src="{{user_photo}}" id="user_photo"/>
        </div>
        <span flex id="title">Dropdown</span>
        <core-icon-button id="navicon" icon="image:flash-on"></core-icon-button>
      </core-toolbar>

      <div class="content">
          
          <div id="maincircuit" class="maincircuit">
            <div class="greeting">{{firstname}}, your circuits for today</div>
            <div class="middle">
              <div horizontal layout>
                <div class="chip-container-main" hero?="{{selected=='main_chip'}}" on-tap="{{transitionDetail}}" flex one style="position:relative;">
                 <!-- Main today_circuit -->
                  <div class="chip" id="main_chip" hero-id="first-{{selected}}" hero?="{{selected=='main_chip'}}" style="position:absolute; width:97%; height:97%; background:#313d46; color:rgba(255, 255, 255, 0.79) !important;" vertical layout>
                    <div class="completed" hidden?="{{!completed_main}}" on-trackStart="{{dragstart}}" on-trackEnd="{{drop}}" id="drag_main">
                      <div style="position: relative; height:100%; width:100%; pointer-events:none;">
                      <div style="position: absolute; top: 22%; pointer-events:none;">
                       <core-icon class="completed-icon" icon="check"></core-icon>
                        Drag to your friend to throwdown
                       </div>
                      </div>
                    </div>
                    <div class="chip-top"><span class="point"><strong>{{main_today_circuit_point}}</strong> pts</span></div>
                    <div class="chip-middle" style="margin: auto auto auto 5%; color:rgba(255, 255, 255, 0.79) !important;"><span class="number">{{main_today_circuit_count}}</span> {{main_today_circuit_unit}}</div>
                    <div class="chip-bottom" style="margin: auto auto auto 5%; color:rgba(255, 255, 255, 0.79) !important;" id="main_today_circuit_exercise_sets">&nbsp;</div>
                    
                  </div>
                </div>
                


                <div flex one>
                <div vertical layout>
                  <div class="chip-container-top" hero?="{{selected=='top_chip'}}"  on-tap="{{transitionDetail}}" flex one>
                    <div class="chip" id="top_chip" hero-id="first-{{selected}}" hero?="{{selected=='top_chip'}}" vertical layout>
                      <div class="completed" hidden?="{{!completed_top}}" on-trackStart="{{dragstart}}" on-trackEnd="{{drop}}" id="drag_top">
                        <core-icon class="completed-icon" icon="check"></core-icon>
                        Drag to your friend to throwdown
                      </div>
                      <div class="chip-top" style="" flex one><span class="point"><strong>{{minor.top.point}}</strong> pts</span></div>
                      <div class="chip-middle" style="text-align:center;" flex two><span class="number">{{minor.top.count}}</span> {{minor.top.unit}}</div>
                      <div class="chip-bottom" style="text-align:center;" flex one id="minor_top_today_circuit_exercise_sets">{{minor.top.name}}</div>
                      
                    </div>
                  </div>


                  <div class="chip-container-bottom" hero?="{{selected=='bottom_chip'}}" on-tap="{{transitionDetail}}" flex one>
                    <div class="chip" id="bottom_chip" hero-id="first-{{selected}}" hero?="{{selected=='bottom_chip'}}" vertical layout>
                      <div class="completed" hidden?="{{!completed_bottom}}" on-trackStart="{{dragstart}}" on-trackEnd="{{drop}}" id="drag_bottom">
                        <core-icon class="completed-icon" icon="check"></core-icon>
                        Drag to your friend to throwdown
                      </div>
                      <div class="chip-top" style="" flex one><span class="point"><strong>{{minor.bottom.point}}</strong> pts</span></div>
                      <div class="chip-middle" style="text-align:center;" flex two><span class="number">{{minor.bottom.count}}</span> {{minor.bottom.unit}}</div>
                      <div class="chip-bottom" style="text-align:center;" flex one id="minor_bottom_today_circuit_exercise_sets">{{minor.bottom.name}}</div>
                      
                    </div>
                  </div>

                </div>
              </div>

                
              </div>
            </div>
      </div>
    </div>
    <paper-tabs selected="{{selectedFriendPage}}" class="transparent-blue">
      <paper-tab><core-icon icon="social:people"></core-icon></paper-tab>
      <paper-tab><core-icon icon="social:person-add"></core-icon></paper-tab>
    </paper-tabs>

    <core-pages selected="{{selectedFriendPage}}">
      <section>
      <core-scroll-threshold id="fl_threshold" scrollTarget="{{$.fl_scroller}}" lowerThreshold="100" on-lower-trigger="{{fl_loadMore}}"></core-scroll-threshold>
      <div id="fl_scroller" class="scroller">
        <template repeat="{{f in friend_list}}">

          <div class="user">
            <img src="{{f.photo_url}}" class="user_photo" />
            <span class="user_name">{{f.first_name}}</span>
            <span class="fl_point">{{f.point}} pts</span>
            <div class="fl_icon_container">
              <span class="fl_throwdown" on-drop="{{drop}}"><core-icon class="fl_icon" icon="image:flash-on" id="throwdown-{{f.id}}"></core-icon> 1</span>
              <span class="fl_throwdown_off" hidden><core-icon class="fl_icon" icon="image:flash-on" id="throwdown-{{f.id}}"></core-icon> 0</span>
              <span class="fl_dropdown"><core-icon class="fl_icon" icon="social:whatshot" id="dropdown-{{f.id}}"></core-icon> 3</span>
              <span class="fl_dropdown_off" hidden><core-icon class="fl_icon" icon="social:whatshot" id="dropdown-{{f.id}}"></core-icon> 0</span>
            </div>
          </div>

        </template>
        <div hidden?="{{!$.fl_threshold.lowerTriggered}}" style="text-align:center;"><paper-spinner active?="{{$.fl_threshold1.lowerTriggered}}" style="margin-top:5px;"></paper-spinner></div>
      </div>
      </section>
      <section>
      <core-scroll-threshold id="p_threshold" scrollTarget="{{$.p_scroller}}" lowerThreshold="100" on-lower-trigger="{{p_loadMore}}"></core-scroll-threshold>
      <div id="p_scroller" class="scroller">
        <template repeat="{{i in public_users}}">

          <div class="user">
            <img src="{{i.photo_url}}" class="user_photo" />
            <span class="user_name">{{i.first_name}} {{i.last_name}}</span>
            <core-icon-button class="add_friend" id="add-friend-{{i.id}}" icon="add" on-tap="{{addFriend}}"></core-icon-button>
          </div>

        </template>
        <div hidden?="{{!$.p_threshold.lowerTriggered}}" style="text-align:center;"><paper-spinner active?="{{$.p_threshold.lowerTriggered}}" style="margin-top:5px;"></paper-spinner></div>
      </div> 
      </section>
    </core-pages>

  </core-header-panel>
  </core-drawer-panel>

</section>

<!-- Detail circuit -->
<section id="details">
<core-animated-pages selected="{{currentEx}}" transitions="hero-transition slide-up slide-down cross-fade slide-from-right list-cascade scale-up" on-core-animated-pages-transition-end="{{complete}}" hero-id="first-{{selected}}" hero> 

<template repeat="{{card in cards}}">
  <div class="card" layout vertical>
    <div class="card-top">
    <core-icon-button id="arrow-back" on-tap="{{transitionDetail}}" icon="arrow-back" style="margin: -11px -17px -8px -10px; float: left;"></core-icon-button>Remaining: {{card.setcount}} {{card.setunit}}</div>
    <div class="card-top-sub" current="{{card.id}}" slide-from-right>{{card.excount}} {{card.exunit}} {{card.exname}}</div>

    <div class="card-bottom" layout vertical>
      <div flex ><img style="margin:50px 0" src="/images/demopic/{{card.exdemopic}}"></div>

        <div style="margin:20px;text-align:right;">
          <paper-fab id="fast-forward" current="{{card.id}}" icon="chevron-right" class="play-icon" on-tap="{{nextExercise}}" scale-up></paper-fab>
        </div>

    </div>
  </div>
</template>

    
</core-animated-pages>
</section>

</core-animated-pages>


<core-localstorage name="firstname" value="{{firstname}}"></core-localstorage>
<core-localstorage name="lastname" value="{{lastname}}"></core-localstorage>
<core-localstorage name="email" value="{{email}}"></core-localstorage>
<core-localstorage name="password" value="{{password}}"></core-localstorage>
<core-localstorage name="user_photo" value="{{user_photo}}"></core-localstorage>
<core-localstorage name="today_circuit" value="{{today_circuit}}"></core-localstorage>
<core-localstorage id="completed_main" name="completed_main" value="{{completed_main}}"></core-localstorage>
<core-localstorage id="completed_top" name="completed_top" value="{{completed_top}}"></core-localstorage>
<core-localstorage id="completed_bottom" name="completed_bottom" value="{{completed_bottom}}"></core-localstorage>


<core-ajax
    id="logout_ajax"
    url="{{server}}/dropdown/default/api/logout.json"
    method="GET"
    handleAs="json"
    on-core-response="{{handleResponseLogout}}"></core-ajax>

</template>

<core-ajax
    id="get_today_circuit"
    url="{{server}}/dropdown/default/api/get_today_circuit.json"
    method="GET"
    handleAs="json"
    on-core-response="{{handleResponseGetTodayCircuit}}"></core-ajax>

</template>


<script>
    supersonic.ui.navigationBar.hide();

    Polymer('drop-down', {
      server: 'http://future-aurora-851.appspot.com',
      page: 0,
      selectedFriendPage:0,
      main_today_circuit_point:0,
      main_today_circuit_count:0,
      main_today_circuit_unit:'loading...',
      minor:{top:{id:0, point:0, count:0, unit: '', name: 'loading...'},
             bottom:{id:0, point:0, count:0, unit: '', name: 'loading...'}},
      exercise_ids_needed : [],
      cached_exercises: {},
      cached_exercise_sets: {},
      set_busy_spinner: true,


      cards:[],
      currentEx: 0,
      start_minor_top: -1,
      start_minor_bottom: -1,
      start_minor_end: -1,
      card_end:-1,
      public_users: [],
      friend_list: [],

      dragstart: function(e,d,s) {
        console.log('dragstart sender', e, s.getAttribute('id'));

        /*s.addEventListener('drag-start', function(e) {
          console.log('event', e);
          var dragInfo = e.detail;
          // flaw #2: e vs dragInfo.event
          var color = 'black';
          dragInfo.avatar.style.cssText = 'border: 3px solid ' + color + '; width: 32px; height: 32px; border-radius: 32px; background-color: whitesmoke';
          e.detail.avatar.appendChild(document.querySelector('#hello'));
          dragInfo.drag = function() {};
          dragInfo.drop = drop;
        });*/

        //var dragInfo = e.dragInfo;
        //console.log('dragInfo', dragInfo);
        //dragInfo.avatar.style.cssText = 'border: 3px solid gray; width: 32px; height: 32px; border-radius: 32px; background-color: whitesmoke';
        //dragInfo.avatar.appendChild('<div>Text</div>');
        console.log('event', e);
      },

      drop: function(e,d,s) {
        console.log('drop', e.relatedTarget.id);
      },

      p_loadMore: function() {
        console.log('called public Loadmore');
        var self=this;

        // get new public users 
        show_user(this.public_users, this.public_users.length);

        setTimeout(function() {
          self.$.p_threshold.clearLower();
          self.set_busy_spinner=false;
        }, 3000);
      },

      fl_loadMore: function() {
        console.log('called friendlist Loadmore');
        var self=this;

        // get new friends 
        show_friends(this.friend_list, this.friend_list.length);

        setTimeout(function() {
          self.$.fl_threshold.clearLower();
          self.set_busy_spinner=false;
        }, 3000);
      },

      addFriend: function(event, detail, sender) {
        console.log(sender.getAttribute('id'));
        var id = parseInt(sender.getAttribute('id').substring(11));
          var param = 'touser=' + id;
          $.ajax({
            url: 'http://dropdown.nguyenshane.com/dropdown/default/api/add_friend.json',
            headers: { 'X-Requested-With': 'XMLHttpRequest',
                      'Authorization': 'Basic ' + getAuth(), },
            data: param,
            dataType: 'json',
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(response){
              console.log('addFriend', response);
            }
          });
      },

      transition: function(e) {
        if (this.page === 2) {
          this.page = 0;
        } else { 
          this.page += 1;
        }
      },
      
      domReady: function() {
        /*this.$.user_photo.addEventListener('drag-start', function(e) {
          console.log('drag-start',e);
        });*/
        var navicon = this.$.navicon;
        var drawerPanel = this.$.drawerPanel
        navicon.onclick = function() {
          drawerPanel.togglePanel();
        };
        console.log(busy = this.$.busy_spinner);
        this.fill_main_today_circuit();
        this.fill_minor_today_circuit();
        this.update_completed_circuits();

        this.refresh();
      },

      refresh: function() {
        this.set_busy_spinner=true;
        this.user_photo = JSON.parse(localStorage.getItem("user_photo"));
        if(this.user_photo == null) this.user_photo = "/images/noavatar.png";

        this.completed_main = JSON.parse(localStorage.getItem("completed_main"));
        this.completed_top = JSON.parse(localStorage.getItem("completed_top"));
        this.completed_bottom = JSON.parse(localStorage.getItem("completed_bottom"));

        this.public_users = [];
        show_user(this.public_users,this.public_users.length);
        show_friends(this.friend_list, this.friend_list.length);
        this.get_today_circuit();
      },

      update_completed_circuits: function() {
        for(var completed of this.today_circuit.completed){
          if (this.main_today_circuit_id == completed.circuit_id)
            this.completed_main = true;
          if (this.minor.top.id == completed.circuit_id)
            this.completed_top = true;
          if (this.minor.bottom.id == completed.circuit_id)
            this.completed_bottom = true;
        }
      },

      get_today_circuit: function(){
        var self = this;
        $.ajax({
            url: 'http://dropdown.nguyenshane.com/dropdown/default/api/get_today_circuit.json',
            headers: { 'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': 'Basic ' + getAuth(), },
            dataType: 'json',
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(response){
                console.log('get_today_circuit', response);

                self.today_circuit = response.result;
                self.insert_today_circuit();
                self.fill_main_today_circuit();
                self.fill_minor_today_circuit();
                self.update_completed_circuits();
                //localStorage.setItem('completed_main', JSON.stringify(true));
            }
         })
      },

      insert_today_circuit: function(){
        var self=this;
        var exercises = this.today_circuit.exercises;
        console.log(this.today_circuit);

        var db = $.db("dropdown", "", "Dropdown Database", 1024 * 1024);
        for (exercise of exercises){
          console.log(exercise, exercise.id, exercise.name, exercise.demopic);
          db.insert("exercise", {
            data: {
                id: exercise.id,
                body: exercise.body,
                name: exercise.name,
                demopic: exercise.demopic
            },
            done: function () {
                console.log("Created an exercise!");
                
            },
            fail: function () {
                console.log("Something went wrong....");
            }
          });
        }

        var exercise_sets = this.today_circuit.exercise_sets;
        for (exercise_set of exercise_sets){
          db.insert("exercise_sets", {
            data: {
                id: exercise_set.id,
                exercise_id: exercise_set.exercise_id,
                set_name: exercise_set.set_name,
                count: exercise_set.count,
                unit: exercise_set.unit,
                point: exercise_set.point
            },
            done: function () {
                console.log("Created an exercise_set!");
            },
            fail: function () {
                console.log("Something went wrong....");
            }
          });
        }

        today_circuits = this.today_circuit.today_circuit;
        db.createTable({
            name: "today_circuit",
            columns: [
                "id INTEGER PRIMARY KEY",
                "circuit_name TEXT",
                "exercise_set_name TEXT",
                "main INTEGER",
                "count INTEGER",
                "unit TEXT",
                "point INTEGER"
            ],
            dropOrIgnore: "drop", 
            done: function () {
                console.log("Created today_circuit database");
                add_today_circuit(today_circuits);
            },
            fail: function () {
                console.log("Something went wrong....");
            }
        });
        
        var add_today_circuit = function(today_circuits){
        console.log(today_circuits);
        for (today_circuit of today_circuits){
          var is_main = 0;
          if(today_circuit.main) {is_main = 1;}
          db.insert("today_circuit", {
            data: {
                id: today_circuit.id,
                circuit_name: today_circuit.circuit_name,
                exercise_set_name: today_circuit.exercise_set_name,
                count: today_circuit.count,
                unit: today_circuit.unit,
                point: today_circuit.point,
                main: is_main
            },
            done: function () {
                console.log("Created a today_circuit!");
                self.set_busy_spinner = false;
            },
            fail: function () {
                console.log("Something went wrong....");
            }
          });
        }
      }
    },
        
    get_exercises: function(exercise_id){
        var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;

          var query = 'SELECT * FROM exercise WHERE id IN (';
          var size = _self.exercise_ids_needed.length;
          for (var i = 0; i < size; i++) {
            query += _self.exercise_ids_needed[i];

            if (i<size-1) query += ',';
          }
          query += ')';

          var cached_exercises = _self.cached_exercises;

          tx.executeSql(query, [], function (tx, results) {
            var len = results.rows.length, i;

            
            for (i = 0; i < len; i++) {
              var id = results.rows.item(i).id; 
              var name = results.rows.item(i).name;
              var body = results.rows.item(i).body;
              var demopic = results.rows.item(i).demopic;              
              self.cached_exercises[id] = {name: name, body: body, demopic: demopic}; 
            }
          });
        },null, function(){_self.exercise_ids_needed.length=0; console.log('cached ex', _self.cached_exercises); _self.build_cards()});
        this.set_busy_spinner=false;
      },

      build_cards: function(){
          // for main circuits
          if (this.start_minor_top == -1) {
            var setcount = this.main_today_circuit_count;
            var setunit = this.main_today_circuit_unit;
            for (var setcountdown = this.main_today_circuit_count; setcountdown > 0; setcountdown--){
              var setname = this.main_exercise_set_name;
              var exercise_set = this.cached_exercise_sets[setname];
              for (var ex_id in exercise_set){
                var excount = exercise_set[ex_id].count;
                var expoint = exercise_set[ex_id].point;
                var exunit = exercise_set[ex_id].unit;
                var exname = this.cached_exercises[ex_id].name;
                var demopic = this.cached_exercises[ex_id].demopic;
                //var body = this.cached_exercises[ex_id].body;
                this.cards.push({setcount:setcountdown, setunit:setunit, excount:excount, exunit:exunit, 
                                     exname:exname, exdemopic:demopic, id:this.cards.length});
              }
            }

            this.start_minor_top = this.cards.length;
          }

          // for top minor circuit
          if (this.start_minor_bottom == -1) {
            var setcount = this.minor.top.count;
            var setunit = this.minor.top.unit;
            for (var setcountdown = this.minor.top.count; setcountdown > 0; setcountdown--){
              var setname = this.minor.top.name;
              var exercise_set = this.cached_exercise_sets[setname];
              for (var ex_id in exercise_set){
                var excount = exercise_set[ex_id].count;
                var expoint = exercise_set[ex_id].point;
                var exunit = exercise_set[ex_id].unit;
                var exname = this.cached_exercises[ex_id].name;
                var demopic = this.cached_exercises[ex_id].demopic;
                //var body = this.cached_exercises[ex_id].body;
                this.cards.push({setcount:setcountdown, setunit:setunit, excount:excount, exunit:exunit, 
                                     exname:exname, exdemopic:demopic, id:this.cards.length});
              }
            }

            this.start_minor_bottom = this.cards.length;
          }


          // for bottom minor circuit
          if (this.card_end == -1) {
            var setcount = this.minor.bottom.count;
            var setunit = this.minor.bottom.unit;
            for (var setcountdown = this.minor.bottom.count; setcountdown > 0; setcountdown--){
              var setname = this.minor.bottom.name;
              var exercise_set = this.cached_exercise_sets[setname];
              for (var ex_id in exercise_set){
                var excount = exercise_set[ex_id].count;
                var expoint = exercise_set[ex_id].point;
                var exunit = exercise_set[ex_id].unit;
                var exname = this.cached_exercises[ex_id].name;
                var demopic = this.cached_exercises[ex_id].demopic;
                //var body = this.cached_exercises[ex_id].body;
                this.cards.push({setcount:setcountdown, setunit:setunit, excount:excount, exunit:exunit, 
                                     exname:exname, exdemopic:demopic, id:this.cards.length});
              }
            }

            this.card_end = this.cards.length;
          }
      },

      fill_main_today_circuit: function() {
        var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
        var _self = this;
        //var main_exercise_set_name = '';

        db.transaction(function (tx) {
          var self = _self;
          //console.log(_self.main_today_circuit_point);
          tx.executeSql('SELECT * FROM today_circuit WHERE main = 1', [], function (tx, results) {
            var len = results.rows.length, i;
            for (i = 0; i < len; i++) {
              //console.log(results.rows.item(i));
              //console.log(self.main_today_circuit_point);
              self.main_today_circuit_point = results.rows.item(i).point;
              self.main_today_circuit_count = results.rows.item(i).count;
              self.main_today_circuit_unit = results.rows.item(i).unit;
              self.main_today_circuit_id = results.rows.item(i).id;

              var main_exercise_set_name = results.rows.item(i).exercise_set_name;
              self.main_exercise_set_name = main_exercise_set_name;
              //console.log(main_exercise_set_name);
              self.fill_main_exercise_set(main_exercise_set_name);
            }            
          });
        });
      },

      fill_main_exercise_set: function(set_name){
        var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
        var _self = this;
        exercise_ids = [];
        exercise_names = [];
        counts = [];
        units = [];
        points = [];
        total_exercise = 0;

        db.transaction(function (tx) {
          var self = _self;
          var exercise_ids_needed = self.exercise_ids_needed;
          self.cached_exercise_sets[set_name] = {};

          var cached_exercise_set = self.cached_exercise_sets[set_name];
          tx.executeSql('SELECT * FROM exercise_sets WHERE set_name = ?', [set_name], function (tx, results) {

            var len = results.rows.length, i;
            total_exercise = len;
            
            for (i = 0; i < len; i++) {
              //console.log(results.rows.item(i));
              var exercise_id = results.rows.item(i).exercise_id;
              exercise_ids[i] = exercise_id;
              exercise_ids_needed.push(exercise_id);

              var count = results.rows.item(i).count;
              counts[i] = count;

              var unit = results.rows.item(i).unit;
              units[i] = unit;

              var point = results.rows.item(i).point;
              points[i] = point;

              cached_exercise_set[exercise_id] = {count: count, unit: unit, point: point};
            }
            render(self);
          });
        });
        
        // get exercise names and render
        function render(s) {
          var _self = s;
          render = '';
          var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
          db.transaction(function (tx) {
            var self = _self;
            var id = exercise_ids[i];

            var query = 'SELECT * FROM exercise WHERE id IN (';
            for (var i = 0; i < total_exercise; i++) {
              query += exercise_ids[i];
              if (i<total_exercise-1) query += ',';
            }
            query += ')';
            //console.log('query',query);

            tx.executeSql(query, [], function (tx, results) {
                var len = results.rows.length, i;
                for (i = 0; i < len; i++) {
                  //console.log(results.rows.item(i));
                  exercise_names[i] = results.rows.item(i).name;
                  //console.log(exercise_names[i]);
                  render += counts[i] + ' ' + exercise_names[i] + '<br>';
                }
                self.injectBoundHTML(render, self.$.main_today_circuit_exercise_sets);
            });
          });
        }
      },


      fill_minor_today_circuit: function() {
        var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;
          //console.log(_self.main_today_circuit_point);
          tx.executeSql('SELECT * FROM today_circuit WHERE main < 1', [], function (tx, results) {
            var len = results.rows.length;

            self.minor.top.id = results.rows.item(0).id;
            self.minor.top.point = results.rows.item(0).point
            self.minor.top.count = results.rows.item(0).count
            self.minor.top.unit = results.rows.item(0).unit
            self.minor.top.name = results.rows.item(0).exercise_set_name;
            self.fill_minor_exercise_set(results.rows.item(0).exercise_set_name);

            self.minor.bottom.id = results.rows.item(1).id;
            self.minor.bottom.point = results.rows.item(1).point
            self.minor.bottom.count = results.rows.item(1).count
            self.minor.bottom.unit = results.rows.item(1).unit
            self.minor.bottom.name = results.rows.item(1).exercise_set_name;
            self.fill_minor_exercise_set(results.rows.item(1).exercise_set_name);

          });
        });
        
      },

      fill_minor_exercise_set: function(set_name){
        var db = openDatabase("dropdown", "", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;

          self.cached_exercise_sets[set_name] = {};

          var cached_exercise_set = self.cached_exercise_sets[set_name];

          tx.executeSql('SELECT * FROM exercise_sets WHERE set_name = ?', [set_name], function (tx, results) {
            var len = results.rows.length, i;
        
            for (i = 0; i < len; i++) {
              var exercise_id = results.rows.item(i).exercise_id;
              self.exercise_ids_needed.push(exercise_id);
              var count = results.rows.item(i).count;
              var unit = results.rows.item(i).unit;
              var point = results.rows.item(i).point;
              cached_exercise_set[exercise_id] = {count: count, unit: unit, point: point};
            }
            //console.log('cached ex set', self.cached_exercise_sets);
            self.get_exercises();
          });
          
        });
      },

      logout: function() {
        this.$.logout_ajax.headers = '{"X-Requested-With": "XMLHttpRequest"' 
              + ', "Authorization": "Basic ' + btoa(this.email + ":" + this.password) + '"}';
        this.$.logout_ajax.go();
      
      },

      settings: function() {
        supersonic.ui.views.find("settings").then(function(view){
          var customAnimation = supersonic.ui.animate("slideFromTop");
          supersonic.ui.layers.push(view, {animation: customAnimation, navigationBar: false, tabBar:false});
          supersonic.ui.navigationBar.hide();
          supersonic.data.channel('index').publish('settings');
        });
      },

      handleResponseLogout: function(e){
        auth = (e.detail.response.success === 'true');
        //console.log(auth);
        
        if (!auth){
          this.firstname = "";
          this.lastname = "";
          this.email = "";
          this.password = "";

          window.localStorage.clear();

          var message = {
            sender: "index",
            content: "logout"
          };

          supersonic.data.channel('index').publish('logout');
          var animation = supersonic.ui.animate("slideFromTop");

          //var initialView = new supersonic.ui.View("login.html");

          //supersonic.ui.layers.push(initialView, {animation:animation});
          supersonic.ui.initialView.show(animation);

          //window.location.replace("login.html");
        } 
        else {
          console.log("Failed logout");
        } 

      },

      toppingsListOrDetails: 0,
      selected: null,

      transitionDetail: function(e) {
        //console.log(e.path);
        var chip_name = e.path[1].id;

        
        for(var i = 0; ;i++){
          chip_name = e.path[i].id;
          if (chip_name != undefined && chip_name != "") {
            if (chip_name == 'start-btn')
              chip_name = 'main_chip';
            if (chip_name != 'arrow-back')
              this.selected = chip_name;
            break;
          }
        }

        //console.log(this.selected);
        
        if (chip_name == 'main_chip' && !this.completed_main){
          this.currentEx = 0;
          this.page = 1;
          
        }
        if (chip_name == 'top_chip' && !this.completed_top){
          this.currentEx = this.start_minor_top;
          this.page = 1;
          
        }
        if (chip_name == 'bottom_chip' && !this.completed_bottom){
          this.currentEx = this.start_minor_bottom;
          this.page = 1;
          
        }
        else if (chip_name == 'arrow-back'){
          this.page = 0;
        }
      },


      nextExercise: function(event, detail, sender) {
        var nextEx = parseInt(sender.getAttribute('current')) + 1;
        //console.log(nextEx, this.cards.length-1);

        //send completion of major circuit
        if (nextEx == this.start_minor_top){
          var circuit_id = 'circuit_id='+this.main_today_circuit_id;
          //console.log('circuit_id',circuit_id);
          // get upload url
          this.$.completed_main.value = true;
          $.ajax({
            url: 'http://dropdown.nguyenshane.com/dropdown/default/api/complete_circuit.json',
            headers: { 'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': 'Basic ' + getAuth(), },
            data: circuit_id,
            dataType: 'json',
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(response){
                console.log('complete_main_circuit', response);
                //localStorage.setItem('completed_main', JSON.stringify(true));
            }
          });
        }

        //send completion of top minor circuit
        if (nextEx == this.start_minor_bottom){
          var circuit_id = 'circuit_id='+this.minor.top.id;
          console.log('circuit_id',circuit_id);
          // get upload url
          this.$.completed_top.value = true;

          $.ajax({
            url: 'http://dropdown.nguyenshane.com/dropdown/default/api/complete_circuit.json',
            headers: { 'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': 'Basic ' + getAuth(), },
            data: circuit_id,
            dataType: 'json',
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(response){
                console.log('complete_top_circuit', response);
                //localStorage.setItem('completed_top', JSON.stringify(true));
            }
          })
        }

        //send completion of top minor circuit
        if (nextEx == this.card_end){
          var circuit_id = 'circuit_id='+this.minor.bottom.id;
          console.log('circuit_id',circuit_id);
          // get upload url
          this.$.completed_bottom.value = true;
          $.ajax({
            url: 'http://dropdown.nguyenshane.com/dropdown/default/api/complete_circuit.json',
            headers: { 'X-Requested-With': 'XMLHttpRequest',
                        'Authorization': 'Basic ' + getAuth(), },
            data: circuit_id,
            dataType: 'json',
            cache: false,
            contentType: false,
            processData: false,
            type: 'GET',
            success: function(response){
                console.log('complete_bottom_circuit', response);
                //localStorage.setItem('completed_bottom', JSON.stringify(true));
            }
          })
        }


        if (nextEx > this.cards.length-1){
          this.page = 0;
          console.log('page',this.page);
          this.currentEx = 0;
        }
        else {
          this.currentEx = nextEx;
        }
      },

      complete: function(e){
        //console.log('complete',e);
      },
      
    });

  </script>


</polymer-element>

<drop-down id="drop-down-index"></drop-down>
<script type="text/javascript">
supersonic.data.channel('all').subscribe(function(message) {
if (message == 'refresh'){
  var drop_down_index = document.querySelector('#drop-down-index');
  console.log(drop_down_index);
  drop_down_index.refresh();
}
});

</script>
</body>
</html>
