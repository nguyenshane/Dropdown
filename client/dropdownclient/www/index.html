<!DOCTYPE html>
<head>
  <title>Drop Down Index</title>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <link rel="stylesheet" href="/components/supersonic/css/supersonic.css">
  <link rel="stylesheet" href="/stylesheets/application.css">
  <link rel="import" href="/components/supersonic/components/import.html">

  <script src="http://localhost/cordova.js"></script>
  <script src="/components/steroids-js/steroids.js"></script>
  <script src="/components/angular/angular.js"></script>
  <script src="/components/supersonic/supersonic.js"></script>

    <!-- Import Polymer -->
  <script src="/components/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="/components/core-elements/core-elements.html">
  <link rel="import" href="/components/core-toolbar/core-toolbar.html">
  <link rel="import" href="/components/core-menu/core-menu.html">
  <link rel="import" href="/components/core-item/core-item.html">
  <link rel="import" href="/components/core-header-panel/core-header-panel.html">
  <link rel="import" href="/components/core-drawer-panel/core-drawer-panel.html">
  <link rel="import" href="/components/core-scroll-header-panel/core-scroll-header-panel.html">
  <link rel="import" href="/components/core-icons/core-icons.html">
  <link rel="import" href="/components/core-icons/image-icons.html">
  <link rel="import" href="/components/core-icons/av-icons.html">
  <link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="/components/paper-button/paper-button.html">
  <link rel="import" href="/components/core-animated-pages/core-animated-pages.html">
  <link rel="import" href="/components/core-animated-pages/transitions/slide-up.html">
  <link rel="import" href="/components/core-animated-pages/transitions/slide-down.html">
  <link rel="import" href="/components/core-animated-pages/transitions/cross-fade.html">
  <link rel="import" href="/components/core-animated-pages/transitions/list-cascade.html">
  <link rel="import" href="/components/core-animated-pages/transitions/scale-up.html">

  <!-- Import Jquery -->
  <script src="/components/localforage/dist/localforage.min.js"></script>
  <script src="/components/jquery/dist/jquery.min.js"></script>
  <script src="/scripts/jquery.db.0.1.3.min.js"></script>

</head>

<body fullbleed layout vertical>
<script>
    supersonic.ui.navigationBar.hide();
</script>
<polymer-element name="drop-down">
<template>
<style>
core-animated-pages {
  height: 100%;
  width: 100%;
  position: initial;
      
}

.greeting {
  text-align: center;
  text-transform: uppercase;
  color: white;
  margin: 20px 0;
}

core-header-panel {
  background: white;
}
core-toolbar#mainheader {
  background-color: #0b8f77;
  color: #fff3ef;
}

.maincircuit {
  background-color: #15b8a3;
  padding: 10px;
}

#navheader {
  background-color: #15b8a3;
}

#title {
  text-align: center;
}
.content {
  
}

.tall {

}

.middle {

}

#start-btn {
  background: #f56b4e;
  color: white;
  margin: 0 auto;
  border-radius: 30px;
  width: 230px;
  text-transform: none;
  margin: 10px auto;
}

#section {
  height: 5000px;
  background: linear-gradient(rgb(214, 227, 231), rgb(173, 216, 230));
}

core-drawer-panel:not([narrow]) #navicon {
  display: none;
}


.chip-container-main {
  text-align: center;
  position: relative;
  
}

.chip-container-top {
  text-align: center;
  position: relative;
  
}

.chip-container-bottom {
  text-align: center;
  position: relative;
  
}

.chip {
  display: inline-block;
  position: relative;
  border-radius: 3px;
  margin: 4px;
  overflow: hidden;
  text-align: start;
  background-color: #00a186;
  box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.16);
  height: 100%;
  color: white;
}

.chip-top {

}

.point {
  background: #e7d67a;
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 0.7em;
  text-transform: lowercase;
  float: right;
  margin: 10px;
  /*box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);*/
  color: #4d4542;
  opacity: 50%;
}

.chip-middle {
  padding: 8px;
}

.number {
  font-size: 3em;
}

.chip-bottom {
  padding: 8px;
  font-size: 1em;


}

.chip-title {
  font-weight: bold;
}
#details {
  padding: 0px;
  /*background: #15b8a3;*/
}

.card {
  height: 100%;
  margin: 0;
  border-radius: 0px;
  text-align: start;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  text-align: center;
}

.card-top {
  padding: 20px;
  color: white;
  font-size: 2em;
  text-align: center;
  background: #0b8f77;
}

.card-top-sub {
  padding: 20px;
  color: white;
  font-size: 2em;
  text-align: center;
  background: #15b8a3;
}

.card-bottom {
  height: 100%;
}

.play-icon {
  border-radius: 60%;
  width: 60px;
  height: 60px;
  margin-right: 16px;
  color: #15b8a3;
}

.play-icon /deep/ core-icon[role=img] {
    height: 100%;
    width: 100%;
    padding: 1px;
    margin: 1px;
  }

.card-album-title {
  font-size: 2em;
}
</style>
<core-animated-pages selected="{{page}}" transitions="hero-transition slide-up slide-down cross-fade list-cascade scale-up" on-core-animated-pages-transition-end="{{complete}}">     
<section>
  <core-drawer-panel id="drawerPanel" rightDrawer>
    
    <core-header-panel drawer>
      <core-toolbar id="navheader" cross-fade>
        <span>Menu</span>
      </core-toolbar>
      <core-menu>
        <core-item label="One"></core-item>
        <core-item label="Log out" on-click="{{logout}}"></core-item>
      </core-menu>
     </core-header-panel>

    <core-header-panel main>
      <core-toolbar id="mainheader">
        <paper-icon-button id="useravatar" icon="account-circle"></paper-icon-button>
        <span flex id="title">Dropdown</span>
        <paper-icon-button id="navicon" icon="image:flash-on"></paper-icon-button>
      </core-toolbar>

      <div class="content">

          <div id="maincircuit" class="maincircuit">
            <!-- <core-icon-button icon="arrow-back" id="core_icon_button"></core-icon-button> -
            <div id="div" flex></div>
            <core-icon-button icon="search" id="core_icon_button1"></core-icon-button>
            <core-icon-button icon="more-vert" id="core_icon_button2"></core-icon-button>
            <div class="top indent">Test</div>  -->
            <div class="greeting">{{firstname}}, your circuits for today</div>
            <div class="middle">
            
           
              <div horizontal layout>
              
                <div class="chip-container-main" hero?="{{selected=='main_chip'}}" on-tap="{{transitionDetail}}" flex one style="position:relative;">
                 <!-- Main today_circuit -->
                  <div class="chip" id="main_chip" hero-id="first-{{selected}}" hero?="{{selected=='main_chip'}}" style="position:absolute; width:97%; height:97%; background:#0b8f77" vertical layout>
                    <div class="chip-top" style=""  ><span class="point"><strong>{{main_today_circuit_point}}</strong> pts</span></div>
                    <div class="chip-middle" style="position: relative;margin: auto 0; left: 5%;" hero-id="second-{{selected}}" hero?="{{selected=='main_chip'}}" ><span class="number">{{main_today_circuit_count}}</span> {{main_today_circuit_unit}}</div>
                    <div class="chip-bottom" style="position: relative;bottom: 10px; left: 5%;" hero-id="third-{{selected}}" hero?="{{selected=='main_chip'}}" id="main_today_circuit_exercise_sets"></div>
                    
                  </div>
                </div>
                


                <div flex one>
                <div vertical layout>
                  <div class="chip-container-top" hero?="{{selected=='top_chip'}}"  on-tap="{{transitionDetail}}" flex one>
                    <div class="chip" id="top_chip" hero-id="first-{{selected}}" hero?="{{selected=='top_chip'}}" vertical layout>
                      <div class="chip-top" style="" flex one><span class="point"><strong>{{minor.top.point}}</strong> pts</span></div>
                      <div class="chip-middle" style="text-align:center;" flex two hero-id="second-{{selected}}" hero?="{{selected=='top_chip'}}" ><span class="number">{{minor.top.count}}</span> {{minor.top.unit}}</div>
                      <div class="chip-bottom" style="text-align:center;" flex one hero-id="third-{{selected}}" hero?="{{selected=='top_chip'}}" id="minor_top_today_circuit_exercise_sets">{{minor.top.name}}</div>
                      
                    </div>
                  </div>


                  <div class="chip-container-bottom" hero?="{{selected=='bottom_chip'}}" on-tap="{{transitionDetail}}" flex one>
                    <div class="chip" id="bottom_chip" hero-id="first-{{selected}}" hero?="{{selected=='bottom_chip'}}" vertical layout>
                      <div class="chip-top" style="" flex one><span class="point"><strong>{{minor.bottom.point}}</strong> pts</span></div>
                      <div class="chip-middle" style="text-align:center;" flex two hero-id="second-{{selected}}" hero?="{{selected=='bottom_chip'}}" ><span class="number">{{minor.bottom.count}}</span> {{minor.bottom.unit}}</div>
                      <div class="chip-bottom" style="text-align:center;" flex one hero-id="third-{{selected}}" hero?="{{selected=='bottom_chip'}}" id="minor_bottom_today_circuit_exercise_sets">{{minor.bottom.name}}</div>
                      
                    </div>
                  </div>

                </div>
              </div>

                
              </div>
            </div>
            <div style="text-align:center;">
            <paper-button class="start-btn" id="start-btn" on-tap="{{transitionDetail}}" raised cross-fade>Start Circuit <core-icon icon="chevron-right"></core-icon></paper-button>
            </div>
          </core-toolbar>
         

      </div>
    </div>

  </core-drawer-panel>

</section>

<!-- Detail circuit -->
<section id="details">
<core-animated-pages selected="{{detailpage}}" transitions="hero-transition slide-up slide-down cross-fade list-cascade scale-up" on-core-animated-pages-transition-end="{{complete}}"> 

<template repeat="{{card in cards}}">
  <div class="card" layout vertical hero-id="first-{{selected}}" hero>
    <div class="card-top" style="background:{{}};" >
    <paper-icon-button id="arrow-back" on-tap="{{transitionDetail}}" icon="arrow-back" style="margin: -4px -10px 0px -10px; padding: 0; float: left;"></paper-icon-button>Remaining: {{card.setcount}} {{card.setunit}}</div>
    <div class="card-top-sub" style="background:{{}};" hero-id="second-{{selected}}">{{card.excount}} {{card.exunit}} {{card.exname}}</div>

    <div class="card-bottom" layout vertical hero-id="third-{{selected}}" >
      <div flex><img style="margin:50px 0" src="/images/{{card.exdemopic}}"></div>

        <div>
          <paper-icon-button id="fast-rewind" icon="av:fast-rewind" class="play-icon"  scale-up></paper-icon-button>
          <paper-icon-button id="play-arrow" icon="av:play-arrow" class="play-icon" scale-up></paper-icon-button>
          <paper-icon-button id="fast-forward" icon="av:fast-forward" class="play-icon" on-tap="{{card.nextExercise}}" scale-up></paper-icon-button>
        </div>

    </div>
  </div>
</template>

    
</core-animated-pages>
</section>

</core-animated-pages>


<core-localstorage name="firstname" value="{{firstname}}"></core-localstorage>
<core-localstorage name="lastname" value="{{lastname}}"></core-localstorage>
<core-localstorage name="email" value="{{email}}"></core-localstorage>
<core-localstorage name="password" value="{{password}}"></core-localstorage>


<core-ajax
    id="logout_ajax"
    url="{{server}}/dropdown/default/api/logout.json"
    method="GET"
    handleAs="json"
    on-core-response="{{handleResponseLogout}}"></core-ajax>

</template>

<core-ajax
    id="logout_ajax"
    url="{{server}}/dropdown/default/api/get_today_circuit.json"
    method="GET"
    handleAs="json"
    on-core-response="{{handleResponseGetTodayCircuit}}"></core-ajax>

</template>


<script>
    supersonic.ui.navigationBar.hide();
    Polymer('drop-down', {
      server: 'http://future-aurora-851.appspot.com',
      page: 0,
      minor:{top:{point:0, count:0, unit: 'u', name: 'name'},
             bottom:{point:0, count:0, unit: 'u', name: 'name'}},
      exercise_ids_needed : [],
      cached_exercises: {},

      cards:[{setcount:1, setunit:'', excount:1, exunit:'', exname:'', exdemopic:'burpees.png'},],

      transition: function(e) {
        if (this.page === 2) {
          this.page = 0;
        } else {
          this.page += 1;
        }
      },
      
      domReady: function() {
          var navicon = this.$.navicon;
          var drawerPanel = this.$.drawerPanel
          navicon.onclick = function() {
            drawerPanel.togglePanel();
          };
          //console.log(this.main_today_circuit_point);
          this.fill_main_today_circuit();
          this.fill_minor_today_circuit();

      },

      get_exercises: function(exercise_id){
        console.log('exercise_ids_needed', this.exercise_ids_needed, this.exercise_ids_needed.length);

        var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;

          var query = 'SELECT * FROM exercise WHERE id IN (';
          var size = _self.exercise_ids_needed.length;
          for (var i = 0; i < size; i++) {
            query += _self.exercise_ids_needed[i];

            if (i<size-1) query += ',';
          }
          query += ')';
          console.log('query', query);

          tx.executeSql(query, [], function (tx, results) {
            var len = results.rows.length, i;
            total_exercise = len;
        
            for (i = 0; i < len; i++) {
              var id = results.rows.item(i).id;
              var name = results.rows.item(i).name;
              console.log('inside', id, name, self.cached_exercises);
              /*
              self.cached_exercises[results.rows.item(i).id].name = results.rows.item(i).name;
              self.cached_exercises[results.rows.item(i).id].body = results.rows.item(i).body;
              self.cached_exercises[results.rows.item(i).id].demopic = results.rows.item(i).demopic;
              */
            }
          });
        },null, function(){_self.exercise_ids_needed.length=0; console.log('cached', _self.cached_exercises)});
      },

      build_cards: function(){
          // for main circuits
          this.cards[0].setcount = self.main_today_circuit_count;
          this.cards[0].setunit = self.main_today_circuit_unit;
          this.cards[0].excount = self.main_today_circuit_unit;

      },

      fill_main_today_circuit: function() {
        var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
        var _self = this;
        //var main_exercise_set_name = '';

        db.transaction(function (tx) {
          var self = _self;
          //console.log(_self.main_today_circuit_point);
          tx.executeSql('SELECT * FROM today_circuit WHERE main = 1', [], function (tx, results) {
            var len = results.rows.length, i;
            for (i = 0; i < len; i++) {
              //console.log(results.rows.item(i));
              //console.log(self.main_today_circuit_point);
              self.main_today_circuit_point = results.rows.item(i).point
              self.main_today_circuit_count = results.rows.item(i).count
              self.main_today_circuit_unit = results.rows.item(i).unit

              var main_exercise_set_name = results.rows.item(i).exercise_set_name;
              //console.log(main_exercise_set_name);
              self.fill_main_exercise_set(main_exercise_set_name);
            }            
          });
        });

        
      },

      fill_main_exercise_set: function(set_name){
        var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
        var _self = this;
        exercise_ids = [];
        exercise_names = [];
        counts = [];
        units = [];
        points = [];
        total_exercise = 0;

        db.transaction(function (tx) {
          var self = _self;
          var exercise_ids_needed = self.exercise_ids_needed;

          tx.executeSql('SELECT * FROM exercise_sets WHERE set_name = ?', [set_name], function (tx, results) {

            var len = results.rows.length, i;
            total_exercise = len;
        
            for (i = 0; i < len; i++) {
              //console.log(results.rows.item(i));
              exercise_ids[i] = results.rows.item(i).exercise_id;
              exercise_ids_needed.push(results.rows.item(i).exercise_id);
              console.log(self.exercise_ids_needed);
              counts[i] = results.rows.item(i).count;
              units[i] = results.rows.item(i).unit;
              points[i] = results.rows.item(i).point;
            }
            render(self);
          });
        });
        
        // get exercise names and render
        function render(s) {
          var _self = s;
          render = '';
          var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
          db.transaction(function (tx) {
            var self = _self;
            var id = exercise_ids[i];

            var query = 'SELECT * FROM exercise WHERE id IN (';
            for (var i = 0; i < total_exercise; i++) {
              query += exercise_ids[i];
              if (i<total_exercise-1) query += ',';
            }
            query += ')';
            console.log('query',query);

            tx.executeSql(query, [], function (tx, results) {
                var len = results.rows.length, i;
                for (i = 0; i < len; i++) {
                  console.log(results.rows.item(i));
                  exercise_names[i] = results.rows.item(i).name;
                  console.log(exercise_names[i]);
                  render += counts[i] + ' ' + exercise_names[i] + '<br>';
                }
                self.injectBoundHTML(render, self.$.main_today_circuit_exercise_sets);
            });
          });
        }
      },


      fill_minor_today_circuit: function() {
        var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;
          //console.log(_self.main_today_circuit_point);
          tx.executeSql('SELECT * FROM today_circuit WHERE main < 1', [], function (tx, results) {
            var len = results.rows.length;

            self.minor.top.point = results.rows.item(0).point
            self.minor.top.count = results.rows.item(0).count
            self.minor.top.unit = results.rows.item(0).unit
            self.minor.top.name = results.rows.item(0).exercise_set_name;
            self.fill_minor_exercise_set(results.rows.item(0).exercise_set_name);

            self.minor.bottom.point = results.rows.item(1).point
            self.minor.bottom.count = results.rows.item(1).count
            self.minor.bottom.unit = results.rows.item(1).unit
            self.minor.bottom.name = results.rows.item(1).exercise_set_name;
            self.fill_minor_exercise_set(results.rows.item(1).exercise_set_name);

          });
        });
        
      },

      fill_minor_exercise_set: function(set_name){
        var db = openDatabase("dropdown", "1.0", "Dropdown Database", 1024 * 1024);
        var _self = this;

        db.transaction(function (tx) {
          var self = _self;
          tx.executeSql('SELECT * FROM exercise_sets WHERE set_name = ?', [set_name], function (tx, results) {
            var len = results.rows.length, i;
        
            for (i = 0; i < len; i++) {
              self.exercise_ids_needed.push(results.rows.item(i).exercise_id);
              console.log(self.exercise_ids_needed);
            }
            self.get_exercises();
          });
          
        });
      },

      logout: function() {
        this.$.logout_ajax.headers = '{"X-Requested-With": "XMLHttpRequest"' 
              + ', "Authorization": "Basic ' + btoa(this.email + ":" + this.password) + '"}';
        this.$.logout_ajax.go();
      
      },

      handleResponseLogout: function(e){
        auth = (e.detail.response.success === 'true');
        console.log(auth);
        
        if (!auth){
          this.firstname = "";
          this.lastname = "";
          this.email = "";
          this.password = "";

          window.localStorage.clear();

          var message = {
            sender: "index",
            content: "logout"
          };

          supersonic.data.channel('index').publish('logout');
          var animation = supersonic.ui.animate("slideFromTop");

          //var initialView = new supersonic.ui.View("login.html");

          //supersonic.ui.layers.push(initialView, {animation:animation});
          supersonic.ui.initialView.show(animation);

          //window.location.replace("login.html");
        } 
        else {
          console.log("Failed logout");
        } 

      },

      handleResponseGetTodayCircuit: function(e){
        console.log(e);
      
      },

      toppingsListOrDetails: 0,
      selected: null,

      transitionDetail: function(e) {
        //console.log(e.path);
        var chip_name = e.path[1].id;

        
        for(var i = 0; ;i++){
          chip_name = e.path[i].id;
          if (chip_name != undefined && chip_name != "") {
            if (chip_name == 'start-btn')
              chip_name = 'main_chip';
            if (chip_name != 'arrow-back')
              this.selected = chip_name;
            break;
          }
        }

        console.log(this.selected);
        
        if (chip_name == 'main_chip'){
          this.page = 1;
        }
        if (chip_name == 'top_chip'){
          this.page = 1;
        }
        if (chip_name == 'bottom_chip'){
          this.page = 1;
        }
        else if (chip_name == 'arrow-back'){
          this.page = 0;
        }
      },

      complete: function(e){
        //console.log('complete',e);
      },
      
    });

  </script>


</polymer-element>

<drop-down></drop-down>

</body>
</html>
